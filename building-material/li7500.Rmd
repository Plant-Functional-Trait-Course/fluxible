---
title: "Using fluxible with the Li7500"
output: github_document
# output: rmarkdown::html_vignette
# vignette: >
#   %\VignetteIndexEntry{Preparing the data for fluxible}
#   %\VignetteEngine{knitr::rmarkdown}
#   %\VignetteEncoding{UTF-8}
# bibliography: biblio_phd_zot.bib
# csl: emerald-harvard.csl
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(tidyverse.quiet = TRUE)
```

In this vignette, we will see how to read the data from the setup described in @halbritterPlantTraitVegetation2024 and compare the output calculated with fluxible with the published data.

The code used to import the data might be turned into a package later.

## Importing and reading the files

First, we import the data from OSF with `dataDownloader::get_file`.

```{r osf-import, include = TRUE}
library(dataDownloader)

get_file("gs8u6",
         "rawData/raw_c-flux",
         "rawC-flux.zip",
         "vignettes/ex_data/li7500")

unzip("vignettes/ex_data/li7500/rawC-flux.zip",
      exdir = "vignettes/ex_data/li7500/rawC-flux")
```

Then we import the data with `licoread::import7500`.
```{r reading}
library(licoread)
library(tidyverse)
pftc5_data <- import7500(
  "vignettes/ex_data/li7500/rawC-flux/rawData/raw_tent-flux",
  plotinfo_names = c("site", "treatment", "date", "plot_id", "trial")
)

pftc5_data <- pftc5_data |>
  mutate(
    f_end = f_start + 120
  )
```


## Processing with fluxible
Since the `licoread::import7500` already provides `f_fluxid`, `f_start` and `f_end`, we can skip `fluxible::flux_match` and directly fit with `fluxible::flux_fitting`.

```{r fitting, message = FALSE, warning = FALSE}
library(fluxible)
pftc5_fits <- flux_fitting(pftc5_data,
                           f_conc = `CO2 umol/mol`,
                           fit_type = "linear",
                           start_cut = 20,
                           end_cut = 10)
```

Using `fluxible::flux_quality` to assess the quality of the dataset.
```{r flags}
pftc5_flags <- flux_quality(pftc5_fits,
                            f_conc = `CO2 umol/mol`,
                            rsquared_threshold = 0.5)
```

```{r sites, include = FALSE, echo = FALSE}
pftc5_flags |>
  dplyr::select(site) |>
  dplyr::distinct()
```

Then plotting (in an external file) for a visual check.
Because of the number of data, we will do it per site to make it lighter.
```{r plotting, eval = FALSE}
pftc5_flags |>
  dplyr::filter(site == "ACJ") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "ACJ_plot")

pftc5_flags |>
  dplyr::filter(site == "PIL") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "PIL_plot")

pftc5_flags |>
  dplyr::filter(site == "QUE") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "QUE_plot")

pftc5_flags |>
  dplyr::filter(site == "TRE") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "TRE_plot")

pftc5_flags |>
  dplyr::filter(site == "WAY") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "WAY_plot")

pftc5_flags |>
  dplyr::filter(f_quality_flag == "zero") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_ylim_upper = 500,
            f_ylim_lower = 350,
            y_text_position = 450,
            f_plotname = "zero_plot")
```

Now let's calculate the fluxes with `fluxible::flux_calc`.
```{r calc}
pftc5_fluxes <- flux_calc(pftc5_flags,
                          slope_col = f_slope_corr,
                          temp_air_col = Temperature,
                          setup_volume = 2197,
                          atm_pressure = pressure_atm,
                          plot_area = 1.44,
                          conc_unit = "ppm",
                          flux_unit = "umol/m2/s",
                          cols_keep = c(
                            "site", "treatment", "date", "plot_id", "trial"
                          ))
```

## Comparison

Let's format the fluxible fluxes in a similar way.
```{r fluxible-format}
pftc5_fluxible_fluxes <- pftc5_fluxes |>
  rename(
    fluxible_flux = "f_flux"
  ) |>
  mutate(
    plot_id = as.integer(str_extract(plot_id, "\\d+")),
    flux = case_when(
      trial == "r" ~ "Reco",
      trial == "p" ~ "NEE",
      trial == "p1" ~ "NEE1", # ideally a column "replicate" for that...
      trial == "p2" ~ "NEE2",
      trial == "p3" ~ "NEE3",
    ),
    date = as_date(f_datetime),
    fluxible_flux = -fluxible_flux # the opposite convention was used for PFTC5
  ) |>
  drop_na(flux) # cleaning
```

Now download and format PFTC5 fluxes.
```{r pftc5-fluxes}
get_file("gs8u6",
         "c-flux",
         "PFTC3_Puna_PFTC5_Peru_2018_2020_Cflux.csv",
         "vignettes/ex_data/li7500")

pftc5_published_fluxes <- read_csv(
  "vignettes/ex_data/li7500/PFTC3_Puna_PFTC5_Peru_2018_2020_Cflux.csv",
  show_col_types = FALSE # quiet!
)

pftc5_published_fluxes <- pftc5_published_fluxes |>
  mutate(
    date = ymd(paste(year, month, day))
  ) |>
  pivot_longer(c(linear_model, nls_model), values_to = "published_fluxes", names_to = "model")
```

Putting them together:
```{r gathering}
pftc5_fluxes_comparison <- left_join(pftc5_published_fluxes, pftc5_fluxible_fluxes, by = join_by(date, flux, site, treatment, plot_id))
```

```{r figure}
pftc5_fluxes_comparison |>
  ggplot(aes(fluxible_flux, published_fluxes, color = model)) +
  theme_bw() +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(
    method = "lm"
  ) +
  geom_text(aes(label = f_fluxid), vjust = -0.5)
```

```{r cleaning, include = FALSE, eval = TRUE}
unlink("building-material/vignettes/ex_data/li7500", recursive = TRUE)
```


