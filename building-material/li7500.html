<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<style type="text/css">
@font-face {
font-family: octicons-link;
src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAZwABAAAAAACFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU0lHAAAGaAAAAAgAAAAIAAAAAUdTVUIAAAZcAAAACgAAAAoAAQAAT1MvMgAAAyQAAABJAAAAYFYEU3RjbWFwAAADcAAAAEUAAACAAJThvmN2dCAAAATkAAAABAAAAAQAAAAAZnBnbQAAA7gAAACyAAABCUM+8IhnYXNwAAAGTAAAABAAAAAQABoAI2dseWYAAAFsAAABPAAAAZwcEq9taGVhZAAAAsgAAAA0AAAANgh4a91oaGVhAAADCAAAABoAAAAkCA8DRGhtdHgAAAL8AAAADAAAAAwGAACfbG9jYQAAAsAAAAAIAAAACABiATBtYXhwAAACqAAAABgAAAAgAA8ASm5hbWUAAAToAAABQgAAAlXu73sOcG9zdAAABiwAAAAeAAAAME3QpOBwcmVwAAAEbAAAAHYAAAB/aFGpk3jaTY6xa8JAGMW/O62BDi0tJLYQincXEypYIiGJjSgHniQ6umTsUEyLm5BV6NDBP8Tpts6F0v+k/0an2i+itHDw3v2+9+DBKTzsJNnWJNTgHEy4BgG3EMI9DCEDOGEXzDADU5hBKMIgNPZqoD3SilVaXZCER3/I7AtxEJLtzzuZfI+VVkprxTlXShWKb3TBecG11rwoNlmmn1P2WYcJczl32etSpKnziC7lQyWe1smVPy/Lt7Kc+0vWY/gAgIIEqAN9we0pwKXreiMasxvabDQMM4riO+qxM2ogwDGOZTXxwxDiycQIcoYFBLj5K3EIaSctAq2kTYiw+ymhce7vwM9jSqO8JyVd5RH9gyTt2+J/yUmYlIR0s04n6+7Vm1ozezUeLEaUjhaDSuXHwVRgvLJn1tQ7xiuVv/ocTRF42mNgZGBgYGbwZOBiAAFGJBIMAAizAFoAAABiAGIAznjaY2BkYGAA4in8zwXi+W2+MjCzMIDApSwvXzC97Z4Ig8N/BxYGZgcgl52BCSQKAA3jCV8CAABfAAAAAAQAAEB42mNgZGBg4f3vACQZQABIMjKgAmYAKEgBXgAAeNpjYGY6wTiBgZWBg2kmUxoDA4MPhGZMYzBi1AHygVLYQUCaawqDA4PChxhmh/8ODDEsvAwHgMKMIDnGL0x7gJQCAwMAJd4MFwAAAHjaY2BgYGaA4DAGRgYQkAHyGMF8NgYrIM3JIAGVYYDT+AEjAwuDFpBmA9KMDEwMCh9i/v8H8sH0/4dQc1iAmAkALaUKLgAAAHjaTY9LDsIgEIbtgqHUPpDi3gPoBVyRTmTddOmqTXThEXqrob2gQ1FjwpDvfwCBdmdXC5AVKFu3e5MfNFJ29KTQT48Ob9/lqYwOGZxeUelN2U2R6+cArgtCJpauW7UQBqnFkUsjAY/kOU1cP+DAgvxwn1chZDwUbd6CFimGXwzwF6tPbFIcjEl+vvmM/byA48e6tWrKArm4ZJlCbdsrxksL1AwWn/yBSJKpYbq8AXaaTb8AAHja28jAwOC00ZrBeQNDQOWO//sdBBgYGRiYWYAEELEwMTE4uzo5Zzo5b2BxdnFOcALxNjA6b2ByTswC8jYwg0VlNuoCTWAMqNzMzsoK1rEhNqByEyerg5PMJlYuVueETKcd/89uBpnpvIEVomeHLoMsAAe1Id4AAAAAAAB42oWQT07CQBTGv0JBhagk7HQzKxca2sJCE1hDt4QF+9JOS0nbaaYDCQfwCJ7Au3AHj+LO13FMmm6cl7785vven0kBjHCBhfpYuNa5Ph1c0e2Xu3jEvWG7UdPDLZ4N92nOm+EBXuAbHmIMSRMs+4aUEd4Nd3CHD8NdvOLTsA2GL8M9PODbcL+hD7C1xoaHeLJSEao0FEW14ckxC+TU8TxvsY6X0eLPmRhry2WVioLpkrbp84LLQPGI7c6sOiUzpWIWS5GzlSgUzzLBSikOPFTOXqly7rqx0Z1Q5BAIoZBSFihQYQOOBEdkCOgXTOHA07HAGjGWiIjaPZNW13/+lm6S9FT7rLHFJ6fQbkATOG1j2OFMucKJJsxIVfQORl+9Jyda6Sl1dUYhSCm1dyClfoeDve4qMYdLEbfqHf3O/AdDumsjAAB42mNgYoAAZQYjBmyAGYQZmdhL8zLdDEydARfoAqIAAAABAAMABwAKABMAB///AA8AAQAAAAAAAAAAAAAAAAABAAAAAA==) format('woff');
}
body {
-webkit-text-size-adjust: 100%;
text-size-adjust: 100%;
color: #333;
font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
font-size: 16px;
line-height: 1.6;
word-wrap: break-word;
}
a {
background-color: transparent;
}
a:active,
a:hover {
outline: 0;
}
strong {
font-weight: bold;
}
h1 {
font-size: 2em;
margin: 0.67em 0;
}
img {
border: 0;
}
hr {
box-sizing: content-box;
height: 0;
}
pre {
overflow: auto;
}
code,
kbd,
pre {
font-family: monospace, monospace;
font-size: 1em;
}
input {
color: inherit;
font: inherit;
margin: 0;
}
html input[disabled] {
cursor: default;
}
input {
line-height: normal;
}
input[type="checkbox"] {
box-sizing: border-box;
padding: 0;
}
table {
border-collapse: collapse;
border-spacing: 0;
}
td,
th {
padding: 0;
}
* {
box-sizing: border-box;
}
input {
font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}
a {
color: #4078c0;
text-decoration: none;
}
a:hover,
a:active {
text-decoration: underline;
}
hr {
height: 0;
margin: 15px 0;
overflow: hidden;
background: transparent;
border: 0;
border-bottom: 1px solid #ddd;
}
hr:before {
display: table;
content: "";
}
hr:after {
display: table;
clear: both;
content: "";
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 15px;
margin-bottom: 15px;
line-height: 1.1;
}
h1 {
font-size: 30px;
}
h2 {
font-size: 21px;
}
h3 {
font-size: 16px;
}
h4 {
font-size: 14px;
}
h5 {
font-size: 12px;
}
h6 {
font-size: 11px;
}
blockquote {
margin: 0;
}
ul,
ol {
padding: 0;
margin-top: 0;
margin-bottom: 0;
}
ol ol,
ul ol {
list-style-type: lower-roman;
}
ul ul ol,
ul ol ol,
ol ul ol,
ol ol ol {
list-style-type: lower-alpha;
}
dd {
margin-left: 0;
}
code {
font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
font-size: 12px;
}
pre {
margin-top: 0;
margin-bottom: 0;
font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}
.select::-ms-expand {
opacity: 0;
}
.octicon {
font: normal normal normal 16px/1 octicons-link;
display: inline-block;
text-decoration: none;
text-rendering: auto;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
.octicon-link:before {
content: '\f05c';
}
.markdown-body:before {
display: table;
content: "";
}
.markdown-body:after {
display: table;
clear: both;
content: "";
}
.markdown-body>*:first-child {
margin-top: 0 !important;
}
.markdown-body>*:last-child {
margin-bottom: 0 !important;
}
a:not([href]) {
color: inherit;
text-decoration: none;
}
.anchor {
display: inline-block;
padding-right: 2px;
margin-left: -18px;
}
.anchor:focus {
outline: none;
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 1em;
margin-bottom: 16px;
font-weight: bold;
line-height: 1.4;
}
h1 .octicon-link,
h2 .octicon-link,
h3 .octicon-link,
h4 .octicon-link,
h5 .octicon-link,
h6 .octicon-link {
color: #000;
vertical-align: middle;
visibility: hidden;
}
h1:hover .anchor,
h2:hover .anchor,
h3:hover .anchor,
h4:hover .anchor,
h5:hover .anchor,
h6:hover .anchor {
text-decoration: none;
}
h1:hover .anchor .octicon-link,
h2:hover .anchor .octicon-link,
h3:hover .anchor .octicon-link,
h4:hover .anchor .octicon-link,
h5:hover .anchor .octicon-link,
h6:hover .anchor .octicon-link {
visibility: visible;
}
h1 {
padding-bottom: 0.3em;
font-size: 2.25em;
line-height: 1.2;
border-bottom: 1px solid #eee;
}
h1 .anchor {
line-height: 1;
}
h2 {
padding-bottom: 0.3em;
font-size: 1.75em;
line-height: 1.225;
border-bottom: 1px solid #eee;
}
h2 .anchor {
line-height: 1;
}
h3 {
font-size: 1.5em;
line-height: 1.43;
}
h3 .anchor {
line-height: 1.2;
}
h4 {
font-size: 1.25em;
}
h4 .anchor {
line-height: 1.2;
}
h5 {
font-size: 1em;
}
h5 .anchor {
line-height: 1.1;
}
h6 {
font-size: 1em;
color: #777;
}
h6 .anchor {
line-height: 1.1;
}
p,
blockquote,
ul,
ol,
dl,
table,
pre {
margin-top: 0;
margin-bottom: 16px;
}
hr {
height: 4px;
padding: 0;
margin: 16px 0;
background-color: #e7e7e7;
border: 0 none;
}
ul,
ol {
padding-left: 2em;
}
ul ul,
ul ol,
ol ol,
ol ul {
margin-top: 0;
margin-bottom: 0;
}
li>p {
margin-top: 16px;
}
dl {
padding: 0;
}
dl dt {
padding: 0;
margin-top: 16px;
font-size: 1em;
font-style: italic;
font-weight: bold;
}
dl dd {
padding: 0 16px;
margin-bottom: 16px;
}
blockquote {
padding: 0 15px;
color: #777;
border-left: 4px solid #ddd;
}
blockquote>:first-child {
margin-top: 0;
}
blockquote>:last-child {
margin-bottom: 0;
}
table {
display: block;
width: 100%;
overflow: auto;
word-break: normal;
word-break: keep-all;
}
table th {
font-weight: bold;
}
table th,
table td {
padding: 6px 13px;
border: 1px solid #ddd;
}
table tr {
background-color: #fff;
border-top: 1px solid #ccc;
}
table tr:nth-child(2n) {
background-color: #f8f8f8;
}
img {
max-width: 100%;
box-sizing: content-box;
background-color: #fff;
}
code {
padding: 0;
padding-top: 0.2em;
padding-bottom: 0.2em;
margin: 0;
font-size: 85%;
background-color: rgba(0,0,0,0.04);
border-radius: 3px;
}
code:before,
code:after {
letter-spacing: -0.2em;
content: "\00a0";
}
pre>code {
padding: 0;
margin: 0;
font-size: 100%;
word-break: normal;
white-space: pre;
background: transparent;
border: 0;
}
.highlight {
margin-bottom: 16px;
}
.highlight pre,
pre {
padding: 16px;
overflow: auto;
font-size: 85%;
line-height: 1.45;
background-color: #f7f7f7;
border-radius: 3px;
}
.highlight pre {
margin-bottom: 0;
word-break: normal;
}
pre {
word-wrap: normal;
}
pre code {
display: inline;
max-width: initial;
padding: 0;
margin: 0;
overflow: initial;
line-height: inherit;
word-wrap: normal;
background-color: transparent;
border: 0;
}
pre code:before,
pre code:after {
content: normal;
}
kbd {
display: inline-block;
padding: 3px 5px;
font-size: 11px;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.pl-c {
color: #969896;
}
.pl-c1,
.pl-s .pl-v {
color: #0086b3;
}
.pl-e,
.pl-en {
color: #795da3;
}
.pl-s .pl-s1,
.pl-smi {
color: #333;
}
.pl-ent {
color: #63a35c;
}
.pl-k {
color: #a71d5d;
}
.pl-pds,
.pl-s,
.pl-s .pl-pse .pl-s1,
.pl-sr,
.pl-sr .pl-cce,
.pl-sr .pl-sra,
.pl-sr .pl-sre {
color: #183691;
}
.pl-v {
color: #ed6a43;
}
.pl-id {
color: #b52a1d;
}
.pl-ii {
background-color: #b52a1d;
color: #f8f8f8;
}
.pl-sr .pl-cce {
color: #63a35c;
font-weight: bold;
}
.pl-ml {
color: #693a17;
}
.pl-mh,
.pl-mh .pl-en,
.pl-ms {
color: #1d3e81;
font-weight: bold;
}
.pl-mq {
color: #008080;
}
.pl-mi {
color: #333;
font-style: italic;
}
.pl-mb {
color: #333;
font-weight: bold;
}
.pl-md {
background-color: #ffecec;
color: #bd2c00;
}
.pl-mi1 {
background-color: #eaffea;
color: #55a532;
}
.pl-mdr {
color: #795da3;
font-weight: bold;
}
.pl-mo {
color: #1d3e81;
}
kbd {
display: inline-block;
padding: 3px 5px;
font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.task-list-item {
list-style-type: none;
}
.task-list-item+.task-list-item {
margin-top: 3px;
}
.task-list-item input {
margin: 0 0.35em 0.25em -1.6em;
vertical-align: middle;
}
:checked+.radio-label {
z-index: 1;
position: relative;
border-color: #4078c0;
}
.sourceLine {
display: inline-block;
}
code .kw { color: #000000; }
code .dt { color: #ed6a43; }
code .dv { color: #009999; }
code .bn { color: #009999; }
code .fl { color: #009999; }
code .ch { color: #009999; }
code .st { color: #183691; }
code .co { color: #969896; }
code .ot { color: #0086b3; }
code .al { color: #a61717; }
code .fu { color: #63a35c; }
code .er { color: #a61717; background-color: #e3d2d2; }
code .wa { color: #000000; }
code .cn { color: #008080; }
code .sc { color: #008080; }
code .vs { color: #183691; }
code .ss { color: #183691; }
code .im { color: #000000; }
code .va {color: #008080; }
code .cf { color: #000000; }
code .op { color: #000000; }
code .bu { color: #000000; }
code .ex { color: #000000; }
code .pp { color: #999999; }
code .at { color: #008080; }
code .do { color: #969896; }
code .an { color: #008080; }
code .cv { color: #008080; }
code .in { color: #008080; }
</style>
<style>
body {
box-sizing: border-box;
min-width: 200px;
max-width: 980px;
margin: 0 auto;
padding: 45px;
padding-top: 0px;
}
</style>


</head>

<body>

<h1 id="using-fluxible-with-the-li7500">Using fluxible with the
Li7500</h1>
<p>In this vignette, we will see how to read the data from the setup
described in @halbritterPlantTraitVegetation2024 and compare the output
calculated with fluxible with the published data.</p>
<p>The code used to import the data might be turned into a package
later.</p>
<h2 id="importing-and-reading-the-files">Importing and reading the
files</h2>
<p>First, we import the data from OSF with
<code>dataDownloader::get_file</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(dataDownloader)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">get_file</span>(<span class="st">&quot;gs8u6&quot;</span>,</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>         <span class="st">&quot;rawData/raw_c-flux&quot;</span>,</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>         <span class="st">&quot;rawC-flux.zip&quot;</span>,</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>         <span class="st">&quot;vignettes/ex_data/li7500&quot;</span>)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co">#&gt; Creating missing path &#39;vignettes/ex_data/li7500&#39;</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co">#&gt; &#39;rawC-flux.zip&#39; downloaded succesfully</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="fu">unzip</span>(<span class="st">&quot;vignettes/ex_data/li7500/rawC-flux.zip&quot;</span>,</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>      <span class="at">exdir =</span> <span class="st">&quot;vignettes/ex_data/li7500/rawC-flux&quot;</span>)</span></code></pre></div>
<p>Then we import the data with <code>licoread::import7500</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(licoread)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>pftc5_data_raw <span class="ot">&lt;-</span> <span class="fu">import7500</span>(</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="st">&quot;vignettes/ex_data/li7500/rawC-flux/rawData/raw_tent-flux&quot;</span>,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="at">plotinfo_names =</span> <span class="fu">c</span>(<span class="st">&quot;site&quot;</span>, <span class="st">&quot;treatment&quot;</span>, <span class="st">&quot;date&quot;</span>, <span class="st">&quot;plot_id&quot;</span>, <span class="st">&quot;trial&quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">#&gt;  ■■■■                              10% |  ETA: 10s</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">#&gt;  ■■■■■■■■■■■■■                     39% |  ETA:  7s</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co">#&gt;  ■■■■■■■■■■■■■■■■■■■■■             67% |  ETA:  4s</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co">#&gt;  ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■     92% |  ETA:  1s</span></span></code></pre></div>
<p>The <code>licoread::import7500</code> function provides
<code>f_fluxid</code>, <code>f_start</code> and <code>f_end</code>,
meaning we could skip <code>fluxible::flux_match</code>. However, those
are based on the start and end of the files, which would require a
strict data collection routine, which was not done there (because there
was no original plans to use fluxible since it did not exist). The
strategy will be to recreate the <code>field_record</code> input. We can
use the <code>t_start</code> and <code>t_finish</code> columns in the
clean data for that, since they correspond to the cuts the team decided
to apply. Note that this is also an example of how fluxible can be used
to process data in a non homogenous way, would that be necessary.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>pftc5_data_raw <span class="ot">&lt;-</span> pftc5_data_raw <span class="sc">|&gt;</span> <span class="co"># will modify import7500 with this naming convention</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  <span class="fu">rename</span>( <span class="co"># a bit of renaming to avoid confusions</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">&quot;f_fluxid&quot;</span>, <span class="co"># f_fluxid will be created by flux_match</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="at">file_start =</span> <span class="st">&quot;f_start&quot;</span>, <span class="co"># same</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>    <span class="at">file_end =</span> <span class="st">&quot;f_end&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  )</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co"># downloading clean data</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="fu">get_file</span>(<span class="st">&quot;gs8u6&quot;</span>,</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>         <span class="st">&quot;c-flux&quot;</span>,</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>         <span class="st">&quot;PFTC3_Puna_PFTC5_Peru_2018_2020_Cflux.csv&quot;</span>,</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>         <span class="st">&quot;vignettes/ex_data/li7500&quot;</span>)</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">#&gt; &#39;PFTC3_Puna_PFTC5_Peru_2018_2020_Cflux.csv&#39; downloaded succesfully</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>pftc5_published_fluxes <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>  <span class="st">&quot;vignettes/ex_data/li7500/PFTC3_Puna_PFTC5_Peru_2018_2020_Cflux.csv&quot;</span>,</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>  <span class="at">show_col_types =</span> <span class="cn">FALSE</span> <span class="co"># quiet!</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>)</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>pftc5_cuts <span class="ot">&lt;-</span> pftc5_published_fluxes <span class="sc">|&gt;</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">ymd</span>(<span class="fu">paste</span>(year, month, day))</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>  <span class="fu">select</span>(date, flux, site, treatment, plot_id, t_start, t_finish)</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co"># t_start and t_finish are relative time</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="co"># we need to fetch datetime from the raw data</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>pftc5_record <span class="ot">&lt;-</span> pftc5_data_raw <span class="sc">|&gt;</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>    <span class="at">plot_id =</span> <span class="fu">as.integer</span>(<span class="fu">str_extract</span>(plot_id, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">d+&quot;</span>)),</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>    <span class="at">flux =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>      trial <span class="sc">==</span> <span class="st">&quot;r&quot;</span> <span class="sc">~</span> <span class="st">&quot;Reco&quot;</span>,</span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>      trial <span class="sc">==</span> <span class="st">&quot;p&quot;</span> <span class="sc">~</span> <span class="st">&quot;NEE&quot;</span>,</span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>      trial <span class="sc">==</span> <span class="st">&quot;p1&quot;</span> <span class="sc">~</span> <span class="st">&quot;NEE1&quot;</span>, <span class="co"># ideally a column &quot;replicate&quot; for that...</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>      trial <span class="sc">==</span> <span class="st">&quot;p2&quot;</span> <span class="sc">~</span> <span class="st">&quot;NEE2&quot;</span>,</span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>      trial <span class="sc">==</span> <span class="st">&quot;p3&quot;</span> <span class="sc">~</span> <span class="st">&quot;NEE3&quot;</span>,</span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a>    ),</span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as_date</span>(f_datetime)</span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>  <span class="fu">select</span>(file_start, date, flux, site, treatment, plot_id) <span class="sc">|&gt;</span></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>  <span class="fu">drop_na</span>(flux) <span class="sc">|&gt;</span></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>  <span class="fu">left_join</span>(pftc5_cuts, <span class="at">by =</span> <span class="fu">join_by</span>(date, flux, site, treatment, plot_id)) <span class="sc">|&gt;</span></span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>    <span class="at">start =</span> file_start <span class="sc">+</span> t_start,</span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>    <span class="at">end =</span> file_start <span class="sc">+</span> t_finish</span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">c</span>(file_start, t_start, t_finish)) <span class="sc">|&gt;</span> <span class="co"># to avoid confusion</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>  <span class="fu">arrange</span>(start)</span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a><span class="co"># Now the meta data are in pftc5_record,</span></span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a><span class="co"># we remove them from pftc5_data to avoid confusion</span></span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a><span class="co"># flux match crashes if columns are both in raw data and record</span></span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a><span class="co"># this will be corrected in next version</span></span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>pftc5_data <span class="ot">&lt;-</span> pftc5_data_raw <span class="sc">|&gt;</span></span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">c</span>(site, treatment, plot_id, trial, date))</span></code></pre></div>
<h2 id="processing-with-fluxible">Processing with fluxible</h2>
<p>Since the <code>licoread::import7500</code> already provides
<code>f_fluxid</code>, <code>f_start</code> and <code>f_end</code>, we
can skip <code>fluxible::flux_match</code> and directly fit with
<code>fluxible::flux_fitting</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">library</span>(fluxible)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>pftc5_match <span class="ot">&lt;-</span> <span class="fu">flux_match</span>(pftc5_data,</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>                          pftc5_record,</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>                          <span class="at">f_datetime =</span> f_datetime,</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>                          <span class="at">start_col =</span> start,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>                          <span class="at">end_col =</span> end)</span></code></pre></div>
<p>The wet air correction should happen here (coming soon).</p>
<h3 id="exponential-model">Exponential model</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>pftc5_fits <span class="ot">&lt;-</span> <span class="fu">flux_fitting</span>(pftc5_match,</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>                           <span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>                           <span class="at">fit_type =</span> <span class="st">&quot;exp_zhao18&quot;</span>,</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>                           <span class="at">start_cut =</span> <span class="dv">0</span>,</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>                           <span class="at">end_cut =</span> <span class="dv">0</span>)</span></code></pre></div>
<p>Using <code>fluxible::flux_quality</code> to assess the quality of
the dataset.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>pftc5_flags <span class="ot">&lt;-</span> <span class="fu">flux_quality</span>(pftc5_fits,</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>                            <span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>                            <span class="at">rsquared_threshold =</span> <span class="fl">0.5</span>)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt;  Total number of measurements: 609</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt;  ok   447     73 %</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt;  start_error      81      13 %</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt;  zero     75      12 %</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#&gt;  discard      6   1 %</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#&gt;  force_discard    0   0 %</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">#&gt;  no_data      0   0 %</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">#&gt;  force_ok     0   0 %</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="co">#&gt;  force_zero   0   0 %</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="co">#&gt;  force_lm     0   0 %</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="co">#&gt;  no_slope     0   0 %</span></span></code></pre></div>
<p>Then plotting (in an external file) for a visual check. Because of
the number of data, we will do it per site to make it lighter.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>pftc5_flags <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;ACJ&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;ACJ_plot&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>pftc5_flags <span class="sc">|&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;PIL&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;PIL_plot&quot;</span>)</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>pftc5_flags <span class="sc">|&gt;</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;QUE&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;QUE_plot&quot;</span>)</span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>pftc5_flags <span class="sc">|&gt;</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;TRE&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;TRE_plot&quot;</span>)</span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>pftc5_flags <span class="sc">|&gt;</span></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;WAY&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;WAY_plot&quot;</span>)</span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>pftc5_flags <span class="sc">|&gt;</span></span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(f_quality_flag <span class="sc">==</span> <span class="st">&quot;zero&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a>            <span class="at">f_ylim_upper =</span> <span class="dv">500</span>,</span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a>            <span class="at">f_ylim_lower =</span> <span class="dv">350</span>,</span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a>            <span class="at">y_text_position =</span> <span class="dv">450</span>,</span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;zero_plot&quot;</span>)</span></code></pre></div>
<p>If other data (PAR and co) need cleaning, that would happen here. To
“compress” environmental variables at a single value per flux, see the
arguments <code>cols_ave</code>, <code>cols_sum</code>, and
<code>cols_med</code> in <code>fluxible::flux_calc</code>. To keep the
raw data (gas concentration or anything else) in a nested column, see
the <code>cols_nest</code> argument.</p>
<p>Now let’s calculate the fluxes with
<code>fluxible::flux_calc</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>pftc5_fluxes <span class="ot">&lt;-</span> <span class="fu">flux_calc</span>(pftc5_flags,</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>                          <span class="at">slope_col =</span> f_slope_corr,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>                          <span class="at">temp_air_col =</span> Temperature,</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>                          <span class="at">setup_volume =</span> <span class="dv">2197</span>,</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>                          <span class="at">atm_pressure =</span> pressure_atm,</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>                          <span class="at">plot_area =</span> <span class="fl">1.44</span>,</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>                          <span class="at">conc_unit =</span> <span class="st">&quot;ppm&quot;</span>,</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>                          <span class="at">flux_unit =</span> <span class="st">&quot;umol/m2/s&quot;</span>,</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>                          <span class="at">cols_keep =</span> <span class="fu">c</span>(</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>                            <span class="st">&quot;site&quot;</span>, <span class="st">&quot;treatment&quot;</span>, <span class="st">&quot;date&quot;</span>, <span class="st">&quot;plot_id&quot;</span>, <span class="st">&quot;flux&quot;</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>                          ))</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="co">#&gt; Cutting data according to &#39;keep_arg&#39;...</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="co">#&gt; Averaging air temperature for each flux...</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a><span class="co">#&gt; Creating a df with the columns from &#39;cols_keep&#39; argument...</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="co">#&gt; Calculating fluxes...</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="co">#&gt; R constant set to 0.082057</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a><span class="co">#&gt; Concentration was measured in ppm</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="co">#&gt; Fluxes are in umol/m2/s</span></span></code></pre></div>
<h3 id="linear-model">Linear model</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>pftc5_fits_lm <span class="ot">&lt;-</span> <span class="fu">flux_fitting</span>(pftc5_match,</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>                           <span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>                           <span class="at">fit_type =</span> <span class="st">&quot;linear&quot;</span>,</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>                           <span class="at">start_cut =</span> <span class="dv">0</span>,</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>                           <span class="at">end_cut =</span> <span class="dv">0</span>)</span></code></pre></div>
<p>Using <code>fluxible::flux_quality</code> to assess the quality of
the dataset.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>pftc5_flags_lm <span class="ot">&lt;-</span> <span class="fu">flux_quality</span>(pftc5_fits_lm,</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>                            <span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>                            <span class="at">rsquared_threshold =</span> <span class="fl">0.5</span>)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">#&gt;  Total number of measurements: 609</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co">#&gt;  ok   481     79 %</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co">#&gt;  start_error      81      13 %</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co">#&gt;  zero     44      7 %</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="co">#&gt;  discard      3   0 %</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="co">#&gt;  force_discard    0   0 %</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="co">#&gt;  no_data      0   0 %</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co">#&gt;  force_ok     0   0 %</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="co">#&gt;  force_zero   0   0 %</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="co">#&gt;  force_lm     0   0 %</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="co">#&gt;  no_slope     0   0 %</span></span></code></pre></div>
<p>Then plotting (in an external file) for a visual check. Because of
the number of data, we will do it per site to make it lighter.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>pftc5_flags_lm <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;ACJ&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;ACJ_plot&quot;</span>)</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>pftc5_flags_lm <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;PIL&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;PIL_plot&quot;</span>)</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>pftc5_flags_lm <span class="sc">|&gt;</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;QUE&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;QUE_plot&quot;</span>)</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>pftc5_flags_lm <span class="sc">|&gt;</span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;TRE&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;TRE_plot&quot;</span>)</span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>pftc5_flags_lm <span class="sc">|&gt;</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">&quot;WAY&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;WAY_plot&quot;</span>)</span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>pftc5_flags_lm <span class="sc">|&gt;</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(f_quality_flag <span class="sc">==</span> <span class="st">&quot;zero&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>  <span class="fu">flux_plot</span>(<span class="at">f_conc =</span> <span class="st">`</span><span class="at">CO2 umol/mol</span><span class="st">`</span>,</span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a>            <span class="at">print_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">&quot;longpdf&quot;</span>,</span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>            <span class="at">f_ylim_upper =</span> <span class="dv">500</span>,</span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a>            <span class="at">f_ylim_lower =</span> <span class="dv">350</span>,</span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a>            <span class="at">y_text_position =</span> <span class="dv">450</span>,</span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a>            <span class="at">f_plotname =</span> <span class="st">&quot;zero_plot&quot;</span>)</span></code></pre></div>
<p>If other data (PAR and co) need cleaning, that would happen here. To
“compress” environmental variables at a single value per flux, see the
arguments <code>cols_ave</code>, <code>cols_sum</code>, and
<code>cols_med</code> in <code>fluxible::flux_calc</code>. To keep the
raw data (gas concentration or anything else) in a nested column, see
the <code>cols_nest</code> argument.</p>
<p>Now let’s calculate the fluxes with
<code>fluxible::flux_calc</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>pftc5_fluxes_lm <span class="ot">&lt;-</span> <span class="fu">flux_calc</span>(pftc5_flags_lm,</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>                          <span class="at">slope_col =</span> f_slope_corr,</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>                          <span class="at">temp_air_col =</span> Temperature,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>                          <span class="at">setup_volume =</span> <span class="dv">2197</span>,</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>                          <span class="at">atm_pressure =</span> pressure_atm,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>                          <span class="at">plot_area =</span> <span class="fl">1.44</span>,</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>                          <span class="at">conc_unit =</span> <span class="st">&quot;ppm&quot;</span>,</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>                          <span class="at">flux_unit =</span> <span class="st">&quot;umol/m2/s&quot;</span>,</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>                          <span class="at">cols_keep =</span> <span class="fu">c</span>(</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>                            <span class="st">&quot;site&quot;</span>, <span class="st">&quot;treatment&quot;</span>, <span class="st">&quot;date&quot;</span>, <span class="st">&quot;plot_id&quot;</span>, <span class="st">&quot;flux&quot;</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>                          ))</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="co">#&gt; Cutting data according to &#39;keep_arg&#39;...</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="co">#&gt; Averaging air temperature for each flux...</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="co">#&gt; Creating a df with the columns from &#39;cols_keep&#39; argument...</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="co">#&gt; Calculating fluxes...</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="co">#&gt; R constant set to 0.082057</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a><span class="co">#&gt; Concentration was measured in ppm</span></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a><span class="co">#&gt; Fluxes are in umol/m2/s</span></span></code></pre></div>
<h2 id="comparison">Comparison</h2>
<p>Let’s format the fluxible fluxes in a similar way.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>pftc5_fluxible_fluxes <span class="ot">&lt;-</span> pftc5_fluxes <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="fu">bind_rows</span>(pftc5_fluxes_lm) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    <span class="at">fluxible_flux =</span> <span class="sc">-</span>f_flux <span class="co"># the opposite convention was used for PFTC5</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  <span class="fu">drop_na</span>(flux) <span class="co"># removing amb measurements</span></span></code></pre></div>
<!-- Now download and format PFTC5 fluxes. -->

<!-- In the clean data on OSF, both linear and nls fluxes are available.
Which one to choose is not explicit (but I am tired, do not quote me on that), so we will just take the one with the lowest aic for now. -->

<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>pftc5_published_fluxes <span class="ot">&lt;-</span> pftc5_published_fluxes <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">ymd</span>(<span class="fu">paste</span>(year, month, day))</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>    <span class="fu">c</span>(linear_model, nls_model),</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;published_fluxes&quot;</span>,</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;model&quot;</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  )</span></code></pre></div>
<p>Putting them together:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>pftc5_fluxes_comparison <span class="ot">&lt;-</span> <span class="fu">left_join</span>(pftc5_published_fluxes,</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>                                     pftc5_fluxible_fluxes,</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>                                     <span class="at">by =</span> <span class="fu">join_by</span>(date, flux,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>                                                  site, treatment,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>                                                  plot_id),</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>                                     <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span>)</span></code></pre></div>

</body>
</html>
