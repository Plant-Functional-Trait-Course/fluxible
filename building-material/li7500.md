Using fluxible with the Li7500
================

In this vignette, we will see how to read the data from the setup
described in @halbritterPlantTraitVegetation2024 and compare the output
calculated with fluxible with the published data.

The code used to import the data might be turned into a package later.

## Importing and reading the files

First, we import the data from OSF with `dataDownloader::get_file`.

``` r
library(dataDownloader)

get_file("gs8u6",
         "rawData/raw_c-flux",
         "rawC-flux.zip",
         "vignettes/ex_data/li7500")
#> rawC-flux.zip already up to date.

unzip("vignettes/ex_data/li7500/rawC-flux.zip",
      exdir = "vignettes/ex_data/li7500/rawC-flux")
```

Then we import the data with `licoread::import7500`.

``` r
library(licoread)
library(tidyverse)
pftc5_data <- import7500(
  "vignettes/ex_data/li7500/rawC-flux/rawData/raw_tent-flux",
  plotinfo_names = c("site", "treatment", "date", "plot_id", "trial")
)
#>  ■■■■■■■■                          23% |  ETA:  8s
#>  ■■■■■■■■■■■■■■■■■                 52% |  ETA:  5s
#>  ■■■■■■■■■■■■■■■■■■■■■■■           75% |  ETA:  3s
#>  ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■    97% |  ETA:  0s

pftc5_data <- pftc5_data |>
  mutate(
    f_end = f_start + 120
  )
```

## Processing with fluxible

Since the `licoread::import7500` already provides `f_fluxid`, `f_start`
and `f_end`, we can skip `fluxible::flux_match` and directly fit with
`fluxible::flux_fitting`.

``` r
library(fluxible)
pftc5_fits <- flux_fitting(pftc5_data,
                           f_conc = `CO2 umol/mol`,
                           fit_type = "linear",
                           start_cut = 20,
                           end_cut = 10)
#> Warning in flux_fitting(pftc5_data, f_conc = `CO2 umol/mol`, fit_type = "linear", : 
#>  fluxID ACJ_B_15mar2018_plot1_a.txt : slope was estimated on 10 points out of 90 seconds
#>  fluxID ACJ_B_15mar2018_plot1_p.txt : slope was estimated on 86 points out of 90 seconds
#>  fluxID ACJ_B_15mar2018_plot1_r.txt : slope was estimated on 83 points out of 90 seconds
#>  fluxID ACJ_B_15mar2018_plot2_a.txt : slope was estimated on 15 points out of 90 seconds
#>  fluxID ACJ_B_15mar2018_plot2_p.txt : slope was estimated on 63 points out of 90 seconds
#>  fluxID ACJ_B_15mar2018_plot3_a.txt : slope was estimated on 19 points out of 90 seconds
#>  fluxID ACJ_B_15mar2018_plot3_p.txt : slope was estimated on 38 points out of 90 seconds
#>  fluxID ACJ_B_15mar2018_plot4_a.txt : slope was estimated on 13 points out of 90 seconds
#>  fluxID ACJ_B_15mar2018_plot5_a.txt : slope was estimated on 16 points out of 90 seconds
#>  fluxID ACJ_B_15mar2018_plot5_p.txt : slope was estimated on 87 points out of 90 seconds
#>  fluxID ACJ_C_15mar2018_plot1_a.txt : slope was estimated on 12 points out of 90 seconds
#>  fluxID ACJ_C_15mar2018_plot2_a.txt : slope was estimated on 9 points out of 90 seconds
#>  fluxID ACJ_C_15mar2018_plot2_p.txt : slope was estimated on 88 points out of 90 seconds
#>  fluxID ACJ_C_15mar2018_plot3_a.txt : slope was estimated on 17 points out of 90 seconds
#>  fluxID ACJ_C_15mar2018_plot3_p.txt : slope was estimated on 54 points out of 90 seconds
#>  fluxID ACJ_C_15mar2018_plot4_a.txt : slope was estimated on 20 points out of 90 seconds
#>  fluxID ACJ_C_15mar2018_plot4_r.txt : slope was estimated on 79 points out of 90 seconds
#>  fluxID ACJ_C_15mar2018_plot5_a.txt : slope was estimated on 10 points out of 90 seconds
#>  fluxID ACJ_C_15mar2018_plot5_p.txt : slope was estimated on 65 points out of 90 seconds
#>  fluxID PIL_B_13mar2018_plot1_a.txt : slope was estimated on 9 points out of 90 seconds
#>  fluxID PIL_B_13mar2018_plot1_p.txt : slope was estimated on 87 points out of 90 seconds
#>  fluxID PIL_B_13mar2018_plot2_a.txt : slope was estimated on 16 points out of 90 seconds
#>  fluxID PIL_B_13mar2018_plot3_a.txt : slope is NA, most likely an issue with the model optimization.
#>         Check your data or use a different model.
#>  fluxID PIL_B_13mar2018_plot4_a.txt : slope was estimated on 13 points out of 90 seconds
#>  fluxID PIL_B_13mar2018_plot4_r.txt : slope was estimated on 83 points out of 90 seconds
#>  fluxID PIL_B_13mar2018_plot5_a.txt : slope was estimated on 17 points out of 90 seconds
#>  fluxID PIL_BB_14mar2018_plot1_a.txt : slope was estimated on 18 points out of 90 seconds
#>  fluxID PIL_BB_14mar2018_plot2_a.txt : slope was estimated on 13 points out of 90 seconds
#>  fluxID PIL_BB_14mar2018_plot2_p.txt : slope was estimated on 68 points out of 90 seconds
#>  fluxID PIL_BB_14mar2018_plot3_a.txt : slope was estimated on 15 points out of 90 seconds
#>  fluxID PIL_C_14mar2018_plot1_a.txt : slope was estimated on 10 points out of 90 seconds
#>  fluxID PIL_C_14mar2018_plot2_a.txt : slope was estimated on 14 points out of 90 seconds
#>  fluxID PIL_C_14mar2018_plot2_r.txt : slope was estimated on 78 points out of 90 seconds
#>  fluxID PIL_C_14mar2018_plot3_a.txt : slope was estimated on 20 points out of 90 seconds
#>  fluxID PIL_C_14mar2018_plot3_p.txt : slope was estimated on 81 points out of 90 seconds
#>  fluxID PIL_C_14mar2018_plot4_a.txt : slope was estimated on 29 points out of 90 seconds
#>  fluxID PIL_C_14mar2018_plot5_a.txt : slope was estimated on 23 points out of 90 seconds
#>  fluxID QUE_B_17mar2018_plot1_a.txt : slope was estimated on 36 points out of 90 seconds
#>  fluxID QUE_B_17mar2018_plot1_p.txt : slope was estimated on 56 points out of 90 seconds
#>  fluxID QUE_B_17mar2018_plot2_a.txt : slope was estimated on 19 points out of 90 seconds
#>  fluxID QUE_B_17mar2018_plot2_r.txt : slope was estimated on 87 points out of 90 seconds
#>  fluxID QUE_B_17mar2018_plot3_a.txt : slope was estimated on 18 points out of 90 seconds
#>  fluxID QUE_B_17mar2018_plot3_p.txt : slope was estimated on 85 points out of 90 seconds
#>  fluxID QUE_B_17mar2018_plot4_a.txt : slope was estimated on 30 points out of 90 seconds
#>  fluxID QUE_B_17mar2018_plot5_a.txt : slope was estimated on 13 points out of 90 seconds
#>  fluxID WAY_B_12mar2018_plot1_a.txt : slope was estimated on 24 points out of 90 seconds
#>  fluxID WAY_B_12mar2018_plot1_p.txt : slope was estimated on 83 points out of 90 seconds
#>  fluxID WAY_B_12mar2018_plot2_a.txt : slope was estimated on 29 points out of 90 seconds
#>  fluxID WAY_B_12mar2018_plot2_r.txt : slope was estimated on 85 points out of 90 seconds
#>  fluxID WAY_B_12mar2018_plot3_a.txt : slope was estimated on 56 points out of 90 seconds
#>  fluxID WAY_B_12mar2018_plot4_a.txt : slope was estimated on 15 points out of 90 seconds
#>  fluxID WAY_B_12mar2018_plot4_r.txt : slope was estimated on 87 points out of 90 seconds
#>  fluxID WAY_B_12mar2018_plot5_a.txt : slope was estimated on 19 points out of 90 seconds
#>  fluxID WAY_C_12mar2018_plot1_a.txt : slope was estimated on 29 points out of 90 seconds
#>  fluxID WAY_C_12mar2018_plot1_p.txt : slope was estimated on 87 points out of 90 seconds
#>  fluxID WAY_C_12mar2018_plot2_a.txt : slope is NA, most likely an issue with the model optimization.
#>         Check your data or use a different model.
#>  fluxID WAY_C_12mar2018_plot3_a.txt : slope was estimated on 24 points out of 90 seconds
#>  fluxID WAY_C_12mar2018_plot4_a.txt : slope was estimated on 21 points out of 90 seconds
#>  fluxID WAY_C_12mar2018_plot5_a.txt : slope was estimated on 12 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot1_a.txt : slope was estimated on 10 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot1_p.txt : slope was estimated on 47 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot1_p1.txt : slope was estimated on 66 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot1_p2.txt : slope was estimated on 73 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot1_p3.txt : slope was estimated on 72 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot1_r.txt : slope was estimated on 71 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot2_a.txt : slope was estimated on 13 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot2_p.txt : slope was estimated on 80 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot2_p1.txt : slope was estimated on 66 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot2_p2.txt : slope was estimated on 68 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot2_p3.txt : slope was estimated on 72 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot2_r.txt : slope was estimated on 71 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot3_a.txt : slope was estimated on 14 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot3_p.txt : slope was estimated on 70 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot3_p1.txt : slope was estimated on 64 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot3_p2.txt : slope was estimated on 44 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot3_p3.txt : slope was estimated on 71 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot3_r.txt : slope was estimated on 58 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot4_a.txt : slope was estimated on 9 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot4_p.txt : slope was estimated on 73 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot4_p1.txt : slope was estimated on 75 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot4_p2.txt : slope was estimated on 68 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot4_p3.txt : slope was estimated on 73 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot4_r.txt : slope was estimated on 65 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot5_a.txt : slope was estimated on 9 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot5_p.txt : slope was estimated on 52 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot5_p1.txt : slope was estimated on 72 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot5_p2.txt : slope was estimated on 70 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot5_p3.txt : slope was estimated on 71 points out of 90 seconds
#>  fluxID ACJ_B_10apr2019_plot5_r.txt : slope was estimated on 68 points out of 90 seconds
#>  fluxID ACJ_C_10apr2019_plot1_a.txt : slope was estimated on 14 points out of 90 seconds
#>  fluxID ACJ_C_10apr2019_plot1_p.txt : sl
```

Using `fluxible::flux_quality` to assess the quality of the dataset.

``` r
pftc5_flags <- flux_quality(pftc5_fits,
                            f_conc = `CO2 umol/mol`,
                            rsquared_threshold = 0.5)
#> 
#>  Total number of measurements: 829
#> 
#>  ok   463     56 %
#>  discard      224     27 %
#>  start_error      83      10 %
#>  zero     59      7 %
#>  force_discard    0   0 %
#>  no_data      0   0 %
#>  force_ok     0   0 %
#>  force_zero   0   0 %
#>  force_lm     0   0 %
#>  no_slope     0   0 %
```

Then plotting (in an external file) for a visual check. Because of the
number of data, we will do it per site to make it lighter.

``` r
pftc5_flags |>
  dplyr::filter(site == "ACJ") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "ACJ_plot")

pftc5_flags |>
  dplyr::filter(site == "PIL") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "PIL_plot")

pftc5_flags |>
  dplyr::filter(site == "QUE") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "QUE_plot")

pftc5_flags |>
  dplyr::filter(site == "TRE") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "TRE_plot")

pftc5_flags |>
  dplyr::filter(site == "WAY") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_plotname = "WAY_plot")

pftc5_flags |>
  dplyr::filter(f_quality_flag == "zero") |>
  flux_plot(f_conc = `CO2 umol/mol`,
            print_plot = FALSE,
            output = "longpdf",
            f_ylim_upper = 500,
            f_ylim_lower = 350,
            y_text_position = 450,
            f_plotname = "zero_plot")
```

Now let’s calculate the fluxes with `fluxible::flux_calc`.

``` r
pftc5_fluxes <- flux_calc(pftc5_flags,
                          slope_col = f_slope_corr,
                          temp_air_col = Temperature,
                          setup_volume = 2197,
                          atm_pressure = pressure_atm,
                          plot_area = 1.44,
                          conc_unit = "ppm",
                          flux_unit = "umol/m2/s",
                          cols_keep = c(
                            "site", "treatment", "date", "plot_id", "trial"
                          ))
#> Cutting data according to 'keep_arg'...
#> Averaging air temperature for each flux...
#> Creating a df with the columns from 'cols_keep' argument...
#> Calculating fluxes...
#> R constant set to 0.082057
#> Concentration was measured in ppm
#> Fluxes are in umol/m2/s
```

## Comparison

Let’s format the fluxible fluxes in a similar way.

``` r
pftc5_fluxible_fluxes <- pftc5_fluxes |>
  rename(
    fluxible_flux = "f_flux"
  ) |>
  mutate(
    plot_id = as.integer(str_extract(plot_id, "\\d+")),
    flux = case_when(
      trial == "r" ~ "Reco",
      trial == "p" ~ "NEE",
      trial == "p1" ~ "NEE1", # ideally a column "replicate" for that...
      trial == "p2" ~ "NEE2",
      trial == "p3" ~ "NEE3",
    ),
    date = as_date(f_datetime),
    fluxible_flux = -fluxible_flux # the opposite convention was used for PFTC5
  ) |>
  drop_na(flux) # cleaning
```

Now download and format PFTC5 fluxes.

``` r
get_file("gs8u6",
         "c-flux",
         "PFTC3_Puna_PFTC5_Peru_2018_2020_Cflux.csv",
         "vignettes/ex_data/li7500")
#> PFTC3_Puna_PFTC5_Peru_2018_2020_Cflux.csv already up to date.

pftc5_published_fluxes <- read_csv(
  "vignettes/ex_data/li7500/PFTC3_Puna_PFTC5_Peru_2018_2020_Cflux.csv",
  show_col_types = FALSE # quiet!
)

pftc5_published_fluxes <- pftc5_published_fluxes |>
  mutate(
    date = ymd(paste(year, month, day))
  ) |>
  pivot_longer(c(linear_model, nls_model), values_to = "published_fluxes", names_to = "model")
```

Putting them together:

``` r
pftc5_fluxes_comparison <- left_join(pftc5_published_fluxes, pftc5_fluxible_fluxes, by = join_by(date, flux, site, treatment, plot_id))
```

``` r
pftc5_fluxes_comparison |>
  ggplot(aes(fluxible_flux, published_fluxes, color = model)) +
  theme_bw() +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(
    method = "lm"
  ) +
  geom_text(aes(label = f_fluxid), vjust = -0.5)
#> `geom_smooth()` using formula = 'y ~ x'
#> Warning: Removed 176 rows containing non-finite outside the scale range
#> (`stat_smooth()`).
#> Warning: Removed 176 rows containing missing values or values outside the scale range
#> (`geom_point()`).
#> Warning: Removed 176 rows containing missing values or values outside the scale range
#> (`geom_text()`).
```

![](li7500_files/figure-gfm/figure-1.png)<!-- -->
